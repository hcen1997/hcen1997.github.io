---
layout: post
---
# 2020年使用springboot的mybatis项目解析
在一个springboot项目, 使用mybatis会引入4个包.
可以分成3类,Mybatis,Mybatis-spring, Mybatis-springboot.  
Mybatis是数据持久化框架, 改善jdbc连接方式.  
Mybatis-spring 使用spring ioc方式管理Mybatis对象.  
Mybatis-spring-boot使用约定和默认配置的方式减少配置项
---

## Mybatis解析
### 架构
* 用户层: 
  1. CRUD映射的xml,接口  
  2. 配置文件
* 核心功能层: (java语句转换为sql并返回java结果)
  1. java函数参数处理(参数映射)
  2. sql解析
  3. sql执行
  4. 结果映射
* 支持层: 
  1. 配置加载
  2. 连接管理
  3. 事务
  4. 缓存
  
  
### 核心包
org.apache.ibatis.session    
org.apache.ibatis.mapping  
org.apache.ibatis.type  
org.apache.ibatis.executor  
org.apache.ibatis.binding


### 类详细解析
* SqlSession 
  1. commit() crud() rollback()
  2. getConnection()  getConfiguration()
  3. 升级 getMapper()
  * 使用方式  use mybatis.jar  
    只使用session方式: session接口中的crud方法
    ```java
    try (SqlSession session = sqlSessionFactory
            .openSession()) {
      Blog blog = (Blog) session.selectOne(
         "org.mybatis.example.BlogMapper.selectBlog", 
         101);
    }
    ```
    隐藏session概念的方式: 只写mapper
    ```java
    try (SqlSession session = sqlSessionFactory
            .openSession()) {
      BlogMapper mapper = session.getMapper(
            BlogMapper.class);
      Blog blog = mapper.selectBlog(101);
    }
    ```
* Executor
判断是否命中缓存
将流程交给StatmentHandler
  * StatementHandler
    * SimpleStatementHandler(无参sql)
    * PreparedStatementHandler(有参sql)

* MapperProxy
SqlSession调用Config, Config调用MapperRegistry, MR调用MapperProxyFactory  
```java
SqlSession:
    session.getMapper();
Config:
    config.getMapper();
MapperRegistry: 
    mapperRegistry.getMapper(){
        knownMappers.get(Class t);
        factory.newInstance();
}    
MapperProxyFactory:
    newInstance(){
        Proxy.newInstance(mapperInterface.getClassLoader,
                  new Class[]{mapperInterface})
}
```  

* ParameterHandler  
  对入参中的#{} ${} 内的变量遍历, 判断java类型, jdbc类型, 查看config中有没有注册
* ResultSetHandler
  类似ParameterHandler, 对于jdbc结果集中的数据判断,检查注册,执行转换


### diff
* mybatis映射java方法到sql语句,而不是想hibernate,映射java类到数据库表  
* hibernet用户创建java类, H框架自动管理表的创建和维护.Mybatis使用相反的方法.
先存在数据库, 然后MBG自动创建java类. 这两种方法各有优点. Mybatis适合程序员无法
 完全掌控数据库,或者数据库中的数据需要多个程序共享. 例如, 某程序需要临时访问一个
 额外的数据库. 或者有dba管理和优化数据库.

### mybatis spring
把mybatis整合入spring框架. 这可以减少程序员适配spring时的依赖管理工作.

使mybatis使用spring的事务管理. 创建mapper和session以注入其他spring管理的bean
 
#### example
```xml
<bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
    <property name="dataSource" ref="dataSource" />
</bean>

<bean id="blogMapper" class="org.mybatis.spring.mapper.MapperFactoryBean">
    <property name="sqlSessionFactory" ref="sqlSessionFactory" />
    <property name="mapperInterface" value="org.mybatis.example.BlogMapper" />
</bean>

<bean id="blogService" class="org.mybatis.example.BlogServiceImpl">
    <property name="blogMapper" ref="blogMapper" />
</bean>
```

Calling MyBatis is now just calling a bean

```java
public class BlogService {

    private BlogMapper blogMapper;

    public void setBlogMapper(BlogMapper blogMapper) {
        this.blogMapper = blogMapper;
    }

    public void doSomethingWithABlog(int blogId) {
        Blog blog = blogMapper.selectBlog(blogId);
        ...
    }
}
```


### mybatis spring boot
This feature allows one to build business code free of configuration.

### MyBatis Generator
MyBatis provides a code generator.
generate MyBatis artifacts needed to perform CRUD operations.

### history
mybatis 在2010年 fork ibatis 3. ibatis 开始于 2002.
java 1.5 发布于 2004, spring 3.0 发布于 2009


### 参考

mybatis总结: https://www.cnblogs.com/cxuanBlog/p/12248536.html  
美团异常实例: https://tech.meituan.com/2020/06/18/inf-bom-mybatis.html  
mybatis文档: https://mybatis.org/mybatis-3/zh/getting-started.html  
mybatis spring 文档: http://mybatis.org/spring/zh/getting-started.html  
mybatis springboot 文档: http://mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/index.html  
wiki: en.wikipedia.org



### more
what is j2ee? what is entreprice need for technology?
I think answer is in books.
Expert One-on-One J2EE design and development.
Expert One-on-One J2EE Development without EJB 